let f=[],m=[],y=[];window.updateSelectOptions=function(t,i,e,a,o){const s=document.getElementById(t);if(!s)return;const d=s.value;i.length===0?(o||(o=s.dataset.noOptionsText||"No options"),s.disabled=!0):s.disabled=!1,o&&(s.innerHTML=`<option value="">${o}</option>`),i.forEach(n=>{const c=document.createElement("option");c.value=typeof e=="function"?e(n):n[e],c.textContent=typeof a=="function"?a(n):n[a],s.appendChild(c)}),d&&Array.from(s.options).some(n=>n.value===d)&&(s.value=d)};function v(t,i){const e=document.getElementById(t);if(!e)return;const o=prompt(`Enter new ${i==="unit_type"?"Unit Type":"Coupon Code"}:`);if(o&&o.trim()){if(e.disabled){e.disabled=!1;const d=e.getAttribute("placeholder");if(d){const n=e.querySelector('option[value=""]');n&&(n.textContent=d)}}const s=document.createElement("option");s.value=o.trim(),s.textContent=o.trim(),s.selected=!0,e.appendChild(s),e.dispatchEvent(new Event("change"))}}function r(){const t=document.getElementById("name");if(!t)return;const i=document.getElementById("property_id"),e=document.getElementById("unit_type"),a=document.getElementById("unit_id"),o=document.getElementById("coupon_code"),s=document.getElementById("suffix"),d=[];if(i&&i.value){const n=i.options[i.selectedIndex];n&&n.text&&d.push(n.text)}if(e&&e.value&&d.push(e.value),a&&a.value){const n=a.options[a.selectedIndex];n&&n.text&&d.push(n.text)}o&&o.value&&d.push("Coupon: "+o.value),s&&s.value&&d.push(s.value),t.value=d.join(" - ")||""}function E(){const t=document.getElementById("base"),i=document.getElementById("parent_rate_id");if(!(!t||!i)&&(i.addEventListener("change",function(){if(this.value){const e=this.options[this.selectedIndex];e&&e.dataset.base&&(t.value=e.dataset.base,t.readOnly=!0,t.classList.add("readonly"))}else t.readOnly=!1,t.classList.remove("readonly")}),i.value)){const e=i.options[i.selectedIndex];e&&e.dataset.base&&(t.value=e.dataset.base,t.readOnly=!0,t.classList.add("readonly"))}}function _(t,i){const e=document.getElementById(t),a=document.getElementById(i);!e||!a||(e.addEventListener("change",function(){this.value&&(a.value="")}),a.addEventListener("change",function(){this.value&&(e.value="")}))}function h(){document.querySelectorAll("select[data-add-new]").forEach(t=>{const i=t.getAttribute("data-add-new"),e=t.closest("fieldset");if(e&&!e.querySelector(".add-custom-btn")){e.classList.add("input-group");const a=document.createElement("div");a.className="items",e.querySelector("label"),t.parentNode.insertBefore(a,t),a.appendChild(t);const o=document.createElement("button");o.type="button",o.className="add-custom-btn",o.textContent="+",o.title=`Add custom ${i}`,o.onclick=()=>v(t.id,i),a.appendChild(o)}})}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("property_id");if(!t)return;const i=document.getElementById("unit_type"),e=document.getElementById("unit_id"),a=document.getElementById("coupon_code"),o=document.getElementById("parent_rate_id"),s=document.getElementById("suffix"),d={};["unit_type","unit_id","coupon_code","parent_rate_id"].forEach(n=>{const c=document.getElementById(n);c&&(d[n]=c.getAttribute("placeholder"))}),window.ratesFormData&&(f=window.ratesFormData.units||[],m=window.ratesFormData.coupons||[],y=window.ratesFormData.unitTypes||[]),E(),_("unit_id","unit_type"),h(),t.addEventListener("change",function(){const n=this.value;if(!n){i&&updateSelectOptions("unit_type",[],"value","text",d.unit_type),e&&updateSelectOptions("unit_id",[],"id","name",d.unit_id),a&&updateSelectOptions("coupon_code",[],"code","code",d.coupon_code),o&&updateSelectOptions("parent_rate_id",[],"id","display_name",d.parent_rate_id),r();return}if(i){const c=y.map(u=>({value:u,text:u}));updateSelectOptions("unit_type",c,"value","text",d.unit_type)}if(e){const c=f.filter(u=>u.property_id==n);updateSelectOptions("unit_id",c,"id",u=>u.name,d.unit_id)}if(a){const c=m.filter(u=>u.property_id==n&&u.is_active);updateSelectOptions("coupon_code",c,"code",u=>u.code+(u.name?" - "+u.name:""),d.coupon_code)}o&&fetch(`/api/parent-rates/${n}`).then(c=>c.json()).then(c=>{const u=c.length===0?o.dataset.noOptionsText||"No options":d.parent_rate_id||"Error placeholder set by JS";o.innerHTML=`<option value="">${u}</option>`,o.disabled=c.length===0,c.forEach(l=>{const p=document.createElement("option");p.value=l.id,p.textContent=`${l.display_name} - ${Number(l.base).toFixed(2)}`,p.dataset.base=l.base,o.appendChild(p)})}).catch(c=>console.error("Error loading parent rates:",c)),r()}),[i,e,a,s].forEach(n=>{n&&(n.addEventListener("change",r),n.addEventListener("input",r))}),t.value&&t.dispatchEvent(new Event("change"))});
