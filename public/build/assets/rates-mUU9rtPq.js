let p=[],r=[],f=[];window.updateSelectOptions=function(t,i,e,o,c){const u=document.getElementById(t);if(!u)return;const d=u.value;c=c||u.querySelector('option[value=""]')?.textContent||"Select...",u.innerHTML=`<option value="">${c}</option>`,i.forEach(n=>{const a=document.createElement("option");a.value=typeof e=="function"?e(n):n[e],a.textContent=typeof o=="function"?o(n):n[o],u.appendChild(a)}),d&&Array.from(u.options).some(n=>n.value===d)&&(u.value=d)};function m(t,i){const e=document.getElementById(t);if(!e)return;const c=prompt(`Enter new ${i==="unit_type"?"Unit Type":"Coupon Code"}:`);if(c&&c.trim()){const u=document.createElement("option");u.value=c.trim(),u.textContent=c.trim(),u.selected=!0,e.appendChild(u),e.dispatchEvent(new Event("change"))}}function l(){const t=document.getElementById("name");if(!t)return;const i=document.getElementById("property_id"),e=document.getElementById("unit_type"),o=document.getElementById("unit_id"),c=document.getElementById("coupon_code"),u=document.getElementById("suffix"),d=[];if(i&&i.value){const n=i.options[i.selectedIndex];n&&n.text&&d.push(n.text)}if(e&&e.value&&d.push(e.value),o&&o.value){const n=o.options[o.selectedIndex];n&&n.text&&d.push(n.text)}c&&c.value&&d.push("Coupon: "+c.value),u&&u.value&&d.push(u.value),t.value=d.join(" - ")||""}function y(){const t=document.getElementById("base"),i=document.getElementById("parent_rate_id");if(!(!t||!i)&&(i.addEventListener("change",function(){if(this.value){const e=this.options[this.selectedIndex];e&&e.dataset.base&&(t.value=e.dataset.base,t.readOnly=!0,t.classList.add("readonly"))}else t.readOnly=!1,t.classList.remove("readonly")}),i.value)){const e=i.options[i.selectedIndex];e&&e.dataset.base&&(t.value=e.dataset.base,t.readOnly=!0,t.classList.add("readonly"))}}function v(t,i){const e=document.getElementById(t),o=document.getElementById(i);!e||!o||(e.addEventListener("change",function(){this.value&&(o.value="")}),o.addEventListener("change",function(){this.value&&(e.value="")}))}function E(){document.querySelectorAll("select[data-add-new]").forEach(t=>{const i=t.getAttribute("data-add-new"),e=t.closest("fieldset");if(e&&!e.querySelector(".add-custom-btn")){const o=document.createElement("button");o.type="button",o.className="add-custom-btn",o.textContent="+",o.title=`Add custom ${i}`,o.onclick=()=>m(t.id,i),t.after(o)}})}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("property_id");if(!t)return;const i=document.getElementById("unit_type"),e=document.getElementById("unit_id"),o=document.getElementById("coupon_code"),c=document.getElementById("parent_rate_id"),u=document.getElementById("suffix");window.ratesFormData&&(p=window.ratesFormData.units||[],r=window.ratesFormData.coupons||[],f=window.ratesFormData.unitTypes||[]),y(),v("unit_id","unit_type"),E(),t.addEventListener("change",function(){const d=this.value;if(!d){i&&updateSelectOptions("unit_type",[],"value","text"),e&&updateSelectOptions("unit_id",[],"id","name"),o&&updateSelectOptions("coupon_code",[],"code","code"),c&&updateSelectOptions("parent_rate_id",[],"id","display_name"),l();return}if(i){const n=f.map(a=>({value:a,text:a}));updateSelectOptions("unit_type",n,"value","text")}if(e){const n=p.filter(a=>a.property_id==d);updateSelectOptions("unit_id",n,"id",a=>a.name)}if(o){const n=r.filter(a=>a.property_id==d&&a.is_active);updateSelectOptions("coupon_code",n,"code",a=>a.code+(a.name?" - "+a.name:""))}c&&fetch(`/api/parent-rates/${d}`).then(n=>n.json()).then(n=>{c.innerHTML=`<option value="">${c.querySelector('option[value=""]')?.textContent||"No parent rate"}</option>`,n.forEach(a=>{const s=document.createElement("option");s.value=a.id,s.textContent=`${a.display_name} - ${Number(a.base).toFixed(2)}`,s.dataset.base=a.base,c.appendChild(s)})}).catch(n=>console.error("Error loading parent rates:",n)),l()}),[i,e,o,u].forEach(d=>{d&&(d.addEventListener("change",l),d.addEventListener("input",l))}),t.value&&t.dispatchEvent(new Event("change"))});
