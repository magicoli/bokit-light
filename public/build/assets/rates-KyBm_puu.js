let p=[],r=[],m=[];window.updateSelectOptions=function(t,i,e,a,o){const c=document.getElementById(t);if(!c)return;const s=c.value;if(!o){const n=c.querySelector('option[value=""]');o=n?n.textContent:"Select..."}c.innerHTML=`<option value="">${o}</option>`,i.forEach(n=>{const d=document.createElement("option");d.value=typeof e=="function"?e(n):n[e],d.textContent=typeof a=="function"?a(n):n[a],c.appendChild(d)}),s&&Array.from(c.options).some(n=>n.value===s)&&(c.value=s)};function f(t,i){const e=document.getElementById(t);if(!e)return;const o=prompt(`Enter new ${i==="unit_type"?"Unit Type":"Coupon Code"}:`);if(o&&o.trim()){const c=document.createElement("option");c.value=o.trim(),c.textContent=o.trim(),c.selected=!0,e.appendChild(c),e.dispatchEvent(new Event("change"))}}function l(){const t=document.getElementById("name");if(!t)return;const i=document.getElementById("property_id"),e=document.getElementById("unit_type"),a=document.getElementById("unit_id"),o=document.getElementById("coupon_code"),c=document.getElementById("suffix"),s=[];if(i&&i.value){const n=i.options[i.selectedIndex];n&&n.text&&s.push(n.text)}if(e&&e.value&&s.push(e.value),a&&a.value){const n=a.options[a.selectedIndex];n&&n.text&&s.push(n.text)}o&&o.value&&s.push("Coupon: "+o.value),c&&c.value&&s.push(c.value),t.value=s.join(" - ")||""}function y(){const t=document.getElementById("base"),i=document.getElementById("parent_rate_id");if(!(!t||!i)&&(i.addEventListener("change",function(){if(this.value){const e=this.options[this.selectedIndex];e&&e.dataset.base&&(t.value=e.dataset.base,t.readOnly=!0,t.classList.add("readonly"))}else t.readOnly=!1,t.classList.remove("readonly")}),i.value)){const e=i.options[i.selectedIndex];e&&e.dataset.base&&(t.value=e.dataset.base,t.readOnly=!0,t.classList.add("readonly"))}}function v(t,i){const e=document.getElementById(t),a=document.getElementById(i);!e||!a||(e.addEventListener("change",function(){this.value&&(a.value="")}),a.addEventListener("change",function(){this.value&&(e.value="")}))}function E(){document.querySelectorAll("select[data-add-new]").forEach(t=>{const i=t.getAttribute("data-add-new"),e=t.closest("fieldset");if(e&&!e.querySelector(".add-custom-btn")){e.classList.add("input-group");const a=document.createElement("div");a.className="items",e.querySelector("label"),t.parentNode.insertBefore(a,t),a.appendChild(t);const o=document.createElement("button");o.type="button",o.className="add-custom-btn",o.textContent="+",o.title=`Add custom ${i}`,o.onclick=()=>f(t.id,i),a.appendChild(o)}})}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("property_id");if(!t)return;const i=document.getElementById("unit_type"),e=document.getElementById("unit_id"),a=document.getElementById("coupon_code"),o=document.getElementById("parent_rate_id"),c=document.getElementById("suffix");window.ratesFormData&&(p=window.ratesFormData.units||[],r=window.ratesFormData.coupons||[],m=window.ratesFormData.unitTypes||[]),y(),v("unit_id","unit_type"),E(),t.addEventListener("change",function(){const s=this.value;if(!s){i&&updateSelectOptions("unit_type",[],"value","text"),e&&updateSelectOptions("unit_id",[],"id","name"),a&&updateSelectOptions("coupon_code",[],"code","code"),o&&updateSelectOptions("parent_rate_id",[],"id","display_name"),l();return}if(i){const n=m.map(d=>({value:d,text:d}));updateSelectOptions("unit_type",n,"value","text")}if(e){const n=p.filter(d=>d.property_id==s);updateSelectOptions("unit_id",n,"id",d=>d.name)}if(a){const n=r.filter(d=>d.property_id==s&&d.is_active);updateSelectOptions("coupon_code",n,"code",d=>d.code+(d.name?" - "+d.name:""))}o&&fetch(`/api/parent-rates/${s}`).then(n=>n.json()).then(n=>{o.innerHTML=`<option value="">${o.querySelector('option[value=""]')?.textContent||"No parent rate"}</option>`,n.forEach(d=>{const u=document.createElement("option");u.value=d.id,u.textContent=`${d.display_name} - ${Number(d.base).toFixed(2)}`,u.dataset.base=d.base,o.appendChild(u)})}).catch(n=>console.error("Error loading parent rates:",n)),l()}),[i,e,a,c].forEach(s=>{s&&(s.addEventListener("change",l),s.addEventListener("input",l))}),t.value&&t.dispatchEvent(new Event("change"))});
