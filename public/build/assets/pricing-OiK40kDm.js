let s=[],f=[];window.updateSelectField=function(l,o,n,c){const t=document.getElementById(l);if(!t)return;const i=t.value,d=c||t.querySelector('option[value=""]')?.textContent||"Select option";t.innerHTML=`<option value="">${d}</option>`,o.forEach(u=>{const{value:r,text:a}=n(u),e=document.createElement("option");e.value=r,e.textContent=a,t.appendChild(e)}),t.value=i};window.addNewOption=function(l,o){const n=prompt(o);if(n){const c=document.getElementById(l);if(c){const t=document.createElement("option");t.value=n,t.textContent=n,c.appendChild(t),c.value=n}}};window.addNewUnitType=function(){addNewOption("unit_type_select","Add new unit type:")};window.addNewCoupon=function(){addNewOption("coupon_select","Add new coupon:")};document.addEventListener("DOMContentLoaded",function(){const l=document.getElementById("property_select"),o=document.getElementById("unit_select"),n=document.getElementById("unit_type_select"),c=document.getElementById("coupon_select"),t=document.getElementById("reference_rate_select");if(!l||!o||!n||!c||!t){console.error("Required form elements not found");return}const i=t.querySelector('option[value=""]')?.textContent||"Select reference rate";l.addEventListener("change",function(){const d=this.value;if(!d){updateSelectField("unit_select",[]),updateSelectField("unit_type_select",[]),updateSelectField("coupon_select",[]),updateSelectField("reference_rate_select",[],null,i);return}const u=s.filter(e=>e.property_id==d);updateSelectField("unit_select",u,e=>({value:e.id,text:`${e.property.name} - ${e.name}`}));const r=[...new Set(u.filter(e=>e.unit_type).map(e=>e.unit_type))];updateSelectField("unit_type_select",r,e=>({value:e,text:e}));const a=f.filter(e=>e.property_id==d&&e.is_active);updateSelectField("coupon_select",a,e=>({value:e.code,text:`${e.code} - ${e.name}`})),fetch(`/api/reference-rates/${d}`).then(e=>e.json()).then(e=>{updateSelectField("reference_rate_select",e,p=>({value:p.id,text:`${p.display_name} - â‚¬${p.base_rate}`}),i)}).catch(e=>console.error("Error loading reference rates:",e))}),o.addEventListener("change",function(){this.value&&(n.value="")}),n.addEventListener("change",function(){this.value&&(o.value="")})});
