let s=[],f=[];window.updateSelectField=function(n,l,o,r){const t=document.getElementById(n);if(!t)return;const i=t.value,c=r||t.querySelector('option[value=""]')?.textContent||"Select option";t.innerHTML=`<option value="">${c}</option>`,l.forEach(d=>{const{value:a,text:u}=o(d),e=document.createElement("option");e.value=a,e.textContent=u,t.appendChild(e)}),t.value=i};window.addNewOption=function(n,l){const o=prompt(l);if(o){const r=document.getElementById(n);if(r){const t=document.createElement("option");t.value=o,t.textContent=o,r.appendChild(t),r.value=o}}};window.addNewUnitType=function(){addNewOption("unit_type_select","Add new unit type:")};window.addNewCoupon=function(){addNewOption("coupon_select","Add new coupon:")};document.addEventListener("DOMContentLoaded",function(){const n=document.getElementById("property_select"),l=document.getElementById("unit_select"),o=document.getElementById("unit_type_select"),r=document.getElementById("coupon_select"),t=document.getElementById("reference_rate_select");if(!n||!l||!o||!r||!t){console.error("Required form elements not found",{propertySelect:!!n,unitSelect:!!l,unitTypeSelect:!!o,couponSelect:!!r,referenceRateSelect:!!t});return}if(n.dataset.units)try{s=JSON.parse(n.dataset.units)}catch(c){console.error("Error parsing units data:",c)}if(n.dataset.coupons)try{f=JSON.parse(n.dataset.coupons)}catch(c){console.error("Error parsing coupons data:",c)}const i=t.querySelector('option[value=""]')?.textContent||"Select reference rate";n.addEventListener("change",function(){const c=this.value;if(!c){updateSelectField("unit_select",[]),updateSelectField("unit_type_select",[]),updateSelectField("coupon_select",[]),updateSelectField("reference_rate_select",[],null,i);return}const d=s.filter(e=>e.property_id==c);updateSelectField("unit_select",d,e=>({value:e.id,text:`${e.property.name} - ${e.name}`}));const a=[...new Set(d.filter(e=>e.unit_type).map(e=>e.unit_type))];updateSelectField("unit_type_select",a,e=>({value:e,text:e}));const u=f.filter(e=>e.property_id==c&&e.is_active);updateSelectField("coupon_select",u,e=>({value:e.code,text:`${e.code} - ${e.name}`})),fetch(`/api/reference-rates/${c}`).then(e=>e.json()).then(e=>{updateSelectField("reference_rate_select",e,p=>({value:p.id,text:`${p.display_name} - â‚¬${p.base_rate}`}),i)}).catch(e=>console.error("Error loading reference rates:",e))}),l.addEventListener("change",function(){this.value&&(o.value="")}),o.addEventListener("change",function(){this.value&&(l.value="")})});
